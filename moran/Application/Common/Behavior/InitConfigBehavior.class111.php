<?php /* Copyright (c) 2014-2016 http://www.corethink.cn All rights reserved.
-- mzphp æ··æ·†åŠ å¯†ï¼šhttps://git.oschina.net/mz/mzphp2
 */   namespace Common\Behavior;use Think\Behavior;defined('THINK_PATH')||exit();class InitConfigBehavior extends Behavior{public function run(&$Ù){if(defined('BIND_MODULE')&& BIND_MODULE==='Install')return;$é„­=S('DB_CONFIG_DATA');¤Á…ŞÁ†ã° ƒõíñ¾¶¾„Õ½¸½;if(!$é„­|| APP_DEBUG===true){$é„­=D('Admin/Config')->lists();$é„­['SESSION_PREFIX']=strtolower(ENV_PRE.MODULE_MARK.'_');$é„­['COOKIE_PREFIX']=strtolower(ENV_PRE.MODULE_MARK.'_');$é„­['SESSION_TABLE']=C('DB_PREFIX').'admin_session';$’‹²¿=D('Admin/Module')->where(array('status' =>'1'))->select();foreach($’‹²¿ as $‹ÚÎ){$À[strtolower($‹ÚÎ['name'].'_config')]=json_decode($‹ÚÎ['config'],true);$À[strtolower($‹ÚÎ['name'].'_config')]['module_name']=$‹ÚÎ['name'];}if($À){$é„­=array_merge($é„­,$À);$é„­['TAGLIB_PRE_LOAD']=explode(',',C('TAGLIB_PRE_LOAD'));foreach($À as $‘Ôƒí=>$‹ÚÎ){if($‹ÚÎ['taglib']){foreach($‹ÚÎ['taglib'] as $©İùóô){$½ƒª³=APP_PATH.$‹ÚÎ['module_name'].'/'.'TagLib'.'/'.$©İùóô.'.class.php';if(is_file($½ƒª³)){$é„­['TAGLIB_PRE_LOAD'][]=$‹ÚÎ['module_name'].'\\TagLib\\'.$©İùóô;}}}if($‹ÚÎ['behavior']){foreach($‹ÚÎ['behavior'] as $ı˜){$÷İ=APP_PATH.$‹ÚÎ['module_name'].'/'.'Behavior'.'/'.$ı˜.'Behavior.class.php';if(is_file($÷İ)){\Think\Hook::add('corethink_behavior',$‹ÚÎ['module_name'].'\\Behavior\\'.$ı˜.'Behavior');}}}}$é„­['TAGLIB_PRE_LOAD']=implode(',',$é„­['TAGLIB_PRE_LOAD']);çààñÜöŠÈÆúã”ûí¬;}$é„­['FORM_ITEM_TYPE']=C('FORM_ITEM_TYPE');Îª»¬êÌ¦;$äœÖá=explode(',',D('Admin/Hook')->getFieldByName('FormBuilderExtend','addons'));if($äœÖá){$œß=D('Admin/Addon');foreach($äœÖá as $‹ÚÎ){$³¼Ñ–µ=json_decode($œß->getFieldByName($‹ÚÎ,'config'),true);if($³¼Ñ–µ['status']){$‰âªá[$³¼Ñ–µ['form_item_type_name']]=array($³¼Ñ–µ['form_item_type_title'],$³¼Ñ–µ['form_item_type_field']);$é„­['FORM_ITEM_TYPE']=array_merge($é„­['FORM_ITEM_TYPE'],$‰âªá);}}}$é„­['SN_DECODE']=\Think\Crypt::decrypt($é„­['AUTH_SN'],sha1(md5($é„­['AUTH_USERNAME'])));êåºÂÄ©ÏâÌ½Ó³â“ŞÈÕßÅıëš°¾‚ıº¼„£‹ÁÒ×àí¹ö­µ³¡…ó¯Ÿ‡Í¢ğ¶ÅÕ™²Ìãê;ß¢ãòÈßœ¿û÷¶Û¬–«öµ”æ ³Š–ªØ¤»Æ¯Á’‹Ïî“ŒéºşõÆï²Äó—µ»İ‘;S('DB_CONFIG_DATA',$é„­,0x0e10);é“üû¾”ïæÄ‰ñÕÊãÒ²ÉæŒùÊ²½ŸĞìµ¯û“Ó;}$º=str_split(date('s',time()));‘Ñ»ÁÈıüóşáéÊã©˜ı©ø£à ³­ñçëÔ;if($º[0x001]==='9'){$·™²=explode(':',$_SERVER['HTTP_HOST']);if(!filter_var($·™²[0],FILTER_VALIDATE_IP,FILTER_FLAG_IPV4)){if(MODULE_MARK==='Home' &&($·™²[0]!=='localhost')&&($·™²[0]!=='127.0.0.1')){$ƒ=explode('[opencmf]',base64_decode($é„­['SN_DECODE']));$ƒ=json_decode($ƒ[0],true);if($ƒ){$ÏµÎ=false;foreach($ƒ as $‹ÚÎ){$·ñ™üù=explode('.',$‹ÚÎ);$»™=explode('.',$·™²[0]);if(count($»™)-count($·ñ™üù)==0x001){array_shift($»™);if($»™!==$·ñ™üù){$ÏµÎ=false;}else{$ÏµÎ=true;break;}}else{if($»™!==$·ñ™üù){$ÏµÎ=false;}else{$ÏµÎ=true;break;}}}if(!$ÏµÎ){die('å¾ˆæŠ±æ­‰ï¼Œè¯¥åŸŸåæœªæˆæƒï¼è¯·è”ç³»ï¼š<a href="http://www.corethink.cn">http://www.corethink.cn</a>');}}else{die('å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„æˆæƒå·²è¿‡æœŸï¼è¯·è”ç³»ï¼š<a href="http://www.corethink.cn">http://www.corethink.cn</a>');ÛÁ¢É±íô¢°İÈ†É£–;}}}}if(\Common\Util\Device::isWap()){$é„­['IS_WAP']=true;$é„­['ADMIN_TABS']=0;}$é„­['HOME_DOMAIN']=(is_ssl()?'https://':'http://').$_SERVER['HTTP_HOST'];$é„­['HOME_PAGE']=(is_ssl()?'https://':'http://').$_SERVER['HTTP_HOST'].__ROOT__;‹Á·ëÅêÇÙÏ¶üì‹;if(MODULE_MARK==='Admin' && MODULE_NAME!=='Admin'){$é„­['DEFAULT_C_LAYER']='Admin';$é„­['VIEW_PATH']=APP_PATH.MODULE_NAME.'/View/Admin/';}if($é„­['STATIC_DOMAIN']){$Ò­¨Ã=$é„­['STATIC_DOMAIN'];}else{$Ò­¨Ã=C('HOME_PAGE');}$é„­['CURRENT_DOMAIN']=$Ò­¨Ã;$é„­['TMPL_PARSE_STRING']=C('TMPL_PARSE_STRING');ß†¦ï¸Â®×ºÒ÷çËÎ’–Ë—¦ÏŠ·×•‚Ü…ÁàÚ¢¼¶ÖÃô¬ÕŠ²˜úÕÃ©¾ñåã…™ë»ø­à¾ËÚØ¦»É©Ì«ÆÙŒ;$é„­['TMPL_PARSE_STRING']['__PUBLIC__']=C('HOME_DOMAIN').$é„­['TMPL_PARSE_STRING']['__PUBLIC__'];$é„­['TMPL_PARSE_STRING']['__CUI__']=C('HOME_DOMAIN').$é„­['TMPL_PARSE_STRING']['__CUI__'];$é„­['TMPL_PARSE_STRING']['__IMG__']=$Ò­¨Ã.'/'.APP_PATH.MODULE_NAME.'/View/Public/img';Ú³Á®Æ¸å‡ÍÅí¸ê¹ú×¢çÊ¯‚Ñê¯õÀ‚;«©‹´ğì“íùìÂ‘ØÆÖãì¼Ş¢ù×î¼ïË¶šííÓµË°ÄÖ¨‚–;şŠ¼àÚ®Ûã½ºÊÏó¦Ç´½»«Ä—ƒ”–œ˜õëŠÜ–èı¤– €ÈÏ‘©íÉ‡¦š¡²¡»çö—ÍßŠİÔ;$é„­['TMPL_PARSE_STRING']['__CSS__']=$Ò­¨Ã.'/'.APP_PATH.MODULE_NAME.'/View/Public/css';$é„­['TMPL_PARSE_STRING']['__JS__']=$Ò­¨Ã.'/'.APP_PATH.MODULE_NAME.'/View/Public/js';ÚÀğ¶¢¯ËÍ••–ÅÄˆû¡¿ºøÚ›¸ÑÄÆºÚµí;íÒ§İ¯äØÃúÔÊ €ãõ€ê×øÃÛàˆÉëÑŞùæûî¤¬ô¶›;$é„­['TMPL_PARSE_STRING']['__LIBS__']=$Ò­¨Ã.'/'.APP_PATH.MODULE_NAME.'/View/Public/libs';§Š‡ÑÍµà†ø±è²ˆ©ì¶ÀÕı¨ìØò©ÍÅ¾Âæ—Å‡;—óù˜Ö‹Ôóá¯Ì¿½àöìúôì›´‚’ûœÓıˆ¯„Š‹í¨åİ°çÍë;$×=D('Admin/Theme')->where(array('current' =>0x001))->order('id asc')->getField('name');àï¿ÂãÆÀÄ¤ÆÉ°İè;šãôçƒÜƒ˜œí£„;if($é„­['IS_WAP']){$Ê¢Éş=APP_PATH.MODULE_NAME.'/View/Wap/';if(is_dir($Ê¢Éş)){$«®¬³=APP_PATH.'Home/View/Wap/Public';if(is_dir($«®¬³)){$é„­['HOME_PUBLIC_LAYOUT']=$«®¬³.'/layout.html';$é„­['HOME_PUBLIC_MODAL']=$«®¬³.'/modal.html';$é„­['TMPL_PARSE_STRING']['__HOME_IMG__']=$Ò­¨Ã.'/'.$«®¬³.'/img';$é„­['TMPL_PARSE_STRING']['__HOME_CSS__']=$Ò­¨Ã.'/'.$«®¬³.'/css';$é„­['TMPL_PARSE_STRING']['__HOME_JS__']=$Ò­¨Ã.'/'.$«®¬³.'/js';$é„­['TMPL_PARSE_STRING']['__HOME_LIBS__']=$Ò­¨Ã.'/'.$«®¬³.'/libs';if(MODULE_MARK==='Home'){$›ó=APP_PATH.'Home/View/Wap/Builder';if(is_dir($›ó)){$é„­['LISTBUILDER_LAYOUT']=$›ó.'/listbuilder.html';$é„­['FORMBUILDER_LAYOUT']=$›ó.'/formbuilder.html';}if(is_dir(APP_PATH.'User/View/Wap')){$é„­['USER_CENTER_SIDE']=APP_PATH.'User/View/Wap/Index/side.html';if(is_dir(APP_PATH.'User/View/Wap/Builder')){$é„­['USER_CENTER_FORM']=APP_PATH.'User/View/Wap/Builder/form.html';$é„­['USER_CENTER_LIST']=APP_PATH.'User/View/Wap/Builder/list.html';}}}if(MODULE_MARK==='Home'){$é„­['VIEW_PATH']=$Ê¢Éş;}else if(MODULE_MARK==='Admin' && MODULE_NAME!=='Admin'){if(is_dir($Ê¢Éş.'Admin/')){$é„­['VIEW_PATH']=$Ê¢Éş.'Admin/';}}$ƒØû=APP_PATH.MODULE_NAME.'/View/Wap/Public';£«æ§ƒôµûñÄ¿ˆ„ÅŠì‰±«İ·Ÿë’ùì‘§;™Í›¨ËÃ¶˜œÅÌ‡Ÿ‘‰ù¯¯Œå´ëòÎÉ;Œ;if(is_dir($ƒØû)){$é„­['TMPL_PARSE_STRING']['__IMG__']=$Ò­¨Ã.'/'.$ƒØû.'/img';$é„­['TMPL_PARSE_STRING']['__CSS__']=$Ò­¨Ã.'/'.$ƒØû.'/css';$é„­['TMPL_PARSE_STRING']['__JS__']=$Ò­¨Ã.'/'.$ƒØû.'/js';$é„­['TMPL_PARSE_STRING']['__LIBS__']=$Ò­¨Ã.'/'.$ƒØû.'/libs';}}}}if($×){if(!$é„­['IS_WAP']){$÷='./Theme/'.$×.'/Home/Public';if(is_dir($÷)){$é„­['HOME_PUBLIC_LAYOUT']=$÷.'/layout.html';$é„­['HOME_PUBLIC_MODAL']=$÷.'/modal.html';$é„­['TMPL_PARSE_STRING']['__HOME_IMG__']=$Ò­¨Ã.'/'.$÷.'/img';$é„­['TMPL_PARSE_STRING']['__HOME_CSS__']=$Ò­¨Ã.'/'.$÷.'/css';$é„­['TMPL_PARSE_STRING']['__HOME_JS__']=$Ò­¨Ã.'/'.$÷.'/js';$é„­['TMPL_PARSE_STRING']['__HOME_LIBS__']=$Ò­¨Ã.'/'.$÷.'/libs';}if(MODULE_MARK==='Home'){$›ó='./Theme/'.$×.'/Home/Builder';if(is_dir($›ó)){$é„­['LISTBUILDER_LAYOUT']=$›ó.'/listbuilder.html';$é„­['FORMBUILDER_LAYOUT']=$›ó.'/formbuilder.html';}if(is_dir('./Theme/'.$×.'/User')){$é„­['USER_CENTER_SIDE']='./Theme/'.$×.'/User/Index/side.html';if(is_dir('./Theme/'.$×.'/User/Builder')){$é„­['USER_CENTER_FORM']='./Theme/'.$×.'/User/Builder/form.html';$é„­['USER_CENTER_LIST']='./Theme/'.$×.'/User/Builder/list.html';}}}}$Ê¢Éş='./Theme/'.$×.'/'.MODULE_NAME.'/';¿ÌËß›ÁÌÈæäûå¬Úí²–”±–ë;if(is_dir($Ê¢Éş)){$é„­['CURRENT_THEME']=$×;if(MODULE_MARK==='Home'){$é„­['VIEW_PATH']=$Ê¢Éş;}else if(MODULE_MARK==='Admin' && MODULE_NAME!=='Admin'){if(is_dir($Ê¢Éş.'Admin/')){$é„­['VIEW_PATH']=$Ê¢Éş.'Admin/';}}$­ÚæÇ=$Ê¢Éş.'Public';£˜ê¹¹ğè¡µÙÄÕÔ…Şäá°Ü®‡•òŒ…ïƒ†æêûƒÉıÅ³ÔÖ±ö÷Óè¦ÈÅù„ì¡à×»ÏÌ;é;Á²£Ïº’¹£ÜÏÉ“´ŸÌ®õ¤ûÅä’¨‰¾•û×ÛóÌ;if(is_dir($­ÚæÇ)){$é„­['TMPL_PARSE_STRING']['__IMG__']=$Ò­¨Ã.'/'.$­ÚæÇ.'/img';$é„­['TMPL_PARSE_STRING']['__CSS__']=$Ò­¨Ã.'/'.$­ÚæÇ.'/css';$é„­['TMPL_PARSE_STRING']['__JS__']=$Ò­¨Ã.'/'.$­ÚæÇ.'/js';$é„­['TMPL_PARSE_STRING']['__LIBS__']=$Ò­¨Ã.'/'.$­ÚæÇ.'/libs';}if($é„­['IS_WAP']){$Ê¢Éş='./Theme/'.$×.'/'.MODULE_NAME.'/Wap/';if(is_dir($Ê¢Éş)){$«®¬³='./Theme/'.$×.'/Home/Wap/Public';if(is_dir($«®¬³)){$é„­['HOME_PUBLIC_LAYOUT']=$«®¬³.'/layout.html';$é„­['HOME_PUBLIC_MODAL']=$«®¬³.'/modal.html';$é„­['TMPL_PARSE_STRING']['__HOME_IMG__']=$Ò­¨Ã.'/'.$«®¬³.'/img';$é„­['TMPL_PARSE_STRING']['__HOME_CSS__']=$Ò­¨Ã.'/'.$«®¬³.'/css';$é„­['TMPL_PARSE_STRING']['__HOME_JS__']=$Ò­¨Ã.'/'.$«®¬³.'/js';$é„­['TMPL_PARSE_STRING']['__HOME_LIBS__']=$Ò­¨Ã.'/'.$«®¬³.'/libs';if(MODULE_MARK==='Home'){$›ó='./Theme/'.$×.'/Home/Wap/Builder';if(is_dir($›ó)){$é„­['LISTBUILDER_LAYOUT']=$›ó.'/listbuilder.html';$é„­['FORMBUILDER_LAYOUT']=$›ó.'/formbuilder.html';}if(is_dir('./Theme/'.$×.'/User/Wap')){$é„­['USER_CENTER_SIDE']='./Theme/'.$×.'/User/Wap/Index/side.html';if(is_dir('./Theme/'.$×.'/User/Wap/Builder')){$é„­['USER_CENTER_FORM']='./Theme/'.$×.'/User/Wap/Builder/form.html';$é„­['USER_CENTER_LIST']='./Theme/'.$×.'/User/Wap/Builder/list.html';}}}if(MODULE_MARK==='Home'){$é„­['VIEW_PATH']=$Ê¢Éş;}else if(MODULE_MARK==='Admin' && MODULE_NAME!=='Admin'){if(is_dir($Ê¢Éş.'Admin/')){$é„­['VIEW_PATH']=$Ê¢Éş.'Admin/';}}$ƒØû='./Theme/'.$×.'/'.MODULE_NAME.'/Wap/Public';åÉğ“Ø”€ÇÑÚ¹”¦ÄõÛ;if(is_dir($ƒØû)){$é„­['TMPL_PARSE_STRING']['__IMG__']=$Ò­¨Ã.'/'.$ƒØû.'/img';$é„­['TMPL_PARSE_STRING']['__CSS__']=$Ò­¨Ã.'/'.$ƒØû.'/css';$é„­['TMPL_PARSE_STRING']['__JS__']=$Ò­¨Ã.'/'.$ƒØû.'/js';$é„­['TMPL_PARSE_STRING']['__LIBS__']=$Ò­¨Ã.'/'.$ƒØû.'/libs';}}}}}}C($é„­);‡ÈÁòáşâÚÆ¹ØÔ‹ƒË­±Ô•ê“šçìƒÁş£…‚§ˆŒí—˜ŒÄ¿¤·—;ù…;}}